<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Discord Bot Control Panel</title>
<style>
  :root{
    --bg1:#071021; --bg2:#0b1220; --ink:#eaf2fa; --muted:#98a6b7;
    --card:rgba(255,255,255,.05); --stroke:rgba(255,255,255,.12);
    --accent:#34d3ff; --accent2:#7c3aed; --ok:#22c55e; --warn:#f59e0b; --err:#ef4444;
  }
  *{box-sizing:border-box} body{margin:0;color:var(--ink);
    background:radial-gradient(1200px 600px at 10% -10%,rgba(52,211,255,.12),transparent 60%),
               linear-gradient(180deg,var(--bg1),var(--bg2));
    font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
  header{position:sticky;top:0;z-index:5;display:flex;gap:10px;align-items:center;padding:16px 18px;
    background:linear-gradient(180deg,rgba(7,16,33,.9),rgba(11,18,32,.85));backdrop-filter:blur(10px);
    border-bottom:1px solid rgba(255,255,255,.06)}
  .logo{width:12px;height:12px;border-radius:4px;background:linear-gradient(135deg,var(--accent),var(--accent2));
    box-shadow:0 0 24px rgba(124,58,237,.35)}
  .wrap{max-width:1100px;margin:20px auto;padding:0 14px}
  .grid{display:grid;gap:14px}
  @media(min-width:900px){.grid{grid-template-columns:1fr 1fr}}
  .card{background:var(--card);border:1px solid var(--stroke);border-radius:14px;padding:14px;box-shadow:0 8px 24px rgba(0,0,0,.2)}
  h3{margin:.2rem 0 .6rem}
  label{display:block;color:var(--muted);font-size:.9rem;margin:6px 0 6px}
  input,select,textarea{width:100%;color:var(--ink);background:rgba(255,255,255,.05);border:1px solid var(--stroke);
    border-radius:10px;padding:10px 12px;outline:none}
  textarea{min-height:96px;resize:vertical}
  .row{display:flex;flex-wrap:wrap;gap:10px}
  .col{flex:1 1 260px}
  button{cursor:pointer;border:none;border-radius:12px;padding:10px 14px;font-weight:700;
    background:linear-gradient(135deg,var(--accent),#67e8f9);color:#00121c;box-shadow:0 6px 18px rgba(52,211,255,.25)}
  button.ghost{background:transparent;color:var(--ink);border:1px solid var(--stroke);box-shadow:none}
  .small{font-size:.9rem} .muted{color:var(--muted)}
  .badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;font-size:.8rem;border:1px solid var(--stroke)}
  ul.list{list-style:none;margin:0;padding:0;display:grid;gap:8px;max-height:240px;overflow:auto}
  .item{display:flex;justify-content:space-between;align-items:center;gap:10px;padding:10px;border-radius:10px;
    background:rgba(255,255,255,.05);border:1px solid var(--stroke)}
  .note-ok{color:var(--ok)} .note-warn{color:var(--warn)} .note-err{color:var(--err)}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace}
  .toast{position:fixed;right:16px;bottom:16px;max-width:320px;padding:10px 12px;border-radius:10px;
    background:rgba(17,24,39,.9);color:#fff;border:1px solid rgba(255,255,255,.15);box-shadow:0 6px 20px rgba(0,0,0,.35);display:none}
</style>
</head>
<body>
<header>
  <div class="logo"></div><strong>Discord Bot Control Panel</strong>
  <div style="margin-left:auto;display:flex;align-items:center;gap:8px">
    <span id="connBadge" class="badge">Disconnected</span>
    <button id="clear" class="ghost">Clear UI</button>
  </div>
</header>

<div class="wrap grid">
  <!-- Connection -->
  <section class="card">
    <h3>Connection</h3>
    <p class="small muted">Your token is only sent to your backend at <span class="mono">/api/auth</span> and is not stored in the browser.</p>
    <div class="row">
      <div class="col">
        <label>Proxy Base URL</label>
        <input id="baseUrl" value="/api" />
      </div>
      <div class="col">
        <label>Bot Token (sent to backend)</label>
        <input id="token" type="password" placeholder="Paste bot token or configure env on server" />
      </div>
      <div class="col" style="align-self:end">
        <button id="connect">Connect</button>
        <button id="disconnect" class="ghost">Disconnect</button>
      </div>
    </div>
    <div id="me" class="small muted" style="margin-top:8px"></div>
    <div id="connectMsg" class="small" style="margin-top:6px"></div>
  </section>

  <!-- Presence -->
  <section class="card">
    <h3>Presence & Status</h3>
    <div class="row">
      <div class="col">
        <label>Status</label>
        <select id="presence">
          <option value="online">online</option>
          <option value="idle">idle</option>
          <option value="dnd">dnd</option>
          <option value="invisible">invisible</option>
        </select>
      </div>
      <div class="col">
        <label>Activity Type</label>
        <select id="activityType">
          <option value="0">Playing</option>
          <option value="2">Listening</option>
          <option value="3">Watching</option>
          <option value="5">Competing</option>
        </select>
      </div>
      <div class="col">
        <label>Activity Text</label>
        <input id="activityText" placeholder="e.g., with Gomega AI" />
      </div>
      <div class="col" style="align-self:end">
        <button id="updatePresence">Update Status</button>
      </div>
    </div>
    <div id="presenceMsg" class="small" style="margin-top:8px"></div>
  </section>

  <!-- DMs -->
  <section class="card">
    <h3>DMs</h3>
    <div class="row">
      <div class="col"><button id="loadDMs" class="ghost">Load DM Channels</button></div>
      <div class="col">
        <label>DM Channel</label>
        <select id="dmSelect"></select>
      </div>
    </div>
    <ul id="dmList" class="list" style="margin-top:10px"></ul>
    <div class="row" style="margin-top:10px">
      <div class="col">
        <label>Message</label>
        <textarea id="dmText" placeholder="Type a message…"></textarea>
      </div>
      <div class="col" style="align-self:end">
        <button id="sendDM">Send DM</button>
      </div>
    </div>
    <div id="dmMsg" class="small" style="margin-top:8px"></div>
  </section>

  <!-- Servers -->
  <section class="card">
    <h3>Servers & Channels</h3>
    <div class="row">
      <div class="col"><button id="loadGuilds" class="ghost">Load Servers</button></div>
      <div class="col">
        <label>Server</label>
        <select id="guildSelect"></select>
      </div>
      <div class="col">
        <label>Text Channel</label>
        <select id="channelSelect"></select>
      </div>
    </div>
    <ul id="guildList" class="list" style="margin-top:10px"></ul>
    <div class="row" style="margin-top:10px">
      <div class="col">
        <label>Message</label>
        <textarea id="guildText" placeholder="Type a message…"></textarea>
      </div>
      <div class="col" style="align-self:end">
        <button id="sendGuild">Send to Channel</button>
      </div>
    </div>
    <div id="guildMsg" class="small" style="margin-top:8px"></div>
  </section>
</div>

<div id="toast" class="toast"></div>

<script>
(function(){
  const els = {
    baseUrl: document.getElementById('baseUrl'),
    token: document.getElementById('token'),
    connect: document.getElementById('connect'),
    disconnect: document.getElementById('disconnect'),
    me: document.getElementById('me'),
    connectMsg: document.getElementById('connectMsg'),
    connBadge: document.getElementById('connBadge'),
    presence: document.getElementById('presence'),
    activityType: document.getElementById('activityType'),
    activityText: document.getElementById('activityText'),
    updatePresence: document.getElementById('updatePresence'),
    presenceMsg: document.getElementById('presenceMsg'),
    loadDMs: document.getElementById('loadDMs'),
    dmSelect: document.getElementById('dmSelect'),
    dmList: document.getElementById('dmList'),
    dmText: document.getElementById('dmText'),
    sendDM: document.getElementById('sendDM'),
    dmMsg: document.getElementById('dmMsg'),
    loadGuilds: document.getElementById('loadGuilds'),
    guildSelect: document.getElementById('guildSelect'),
    channelSelect: document.getElementById('channelSelect'),
    guildList: document.getElementById('guildList'),
    guildText: document.getElementById('guildText'),
    sendGuild: document.getElementById('sendGuild'),
    guildMsg: document.getElementById('guildMsg'),
    clear: document.getElementById('clear'),
    toast: document.getElementById('toast'),
  };

  // persist only baseUrl for convenience
  els.baseUrl.value = localStorage.getItem('bot_base_url') || '/api';
  els.baseUrl.addEventListener('change', ()=>localStorage.setItem('bot_base_url', els.baseUrl.value));

  function setBadge(text, kind){
    els.connBadge.textContent = text;
    els.connBadge.style.background =
      kind==='ok' ? 'rgba(34,197,94,.15)' :
      kind==='err' ? 'rgba(239,68,68,.15)' :
      'rgba(255,255,255,.06)';
  }
  function note(el, text, kind){ el.textContent = text||''; el.className = 'small ' + (kind || ''); }
  function toast(msg){
    els.toast.textContent = msg;
    els.toast.style.display = 'block';
    setTimeout(()=> els.toast.style.display='none', 2200);
  }
  function api(path, options={}){
    const url = (els.baseUrl.value||'/api').replace(/\/$/,'') + path;
    return fetch(url, {
      ...options,
      headers: { 'Content-Type':'application/json', ...(options.headers||{}) }
    }).then(async res=>{
      if(!res.ok){
        const txt = await res.text().catch(()=> '');
        throw new Error('HTTP '+res.status+(txt?(': '+txt):''));
      }
      // some endpoints may return {} only
      try { return await res.json(); } catch { return {}; }
    });
  }

  // ---- Connect / Disconnect
  els.connect.addEventListener('click', async ()=>{
    note(els.connectMsg, 'Connecting…', 'muted');
    try{
      const t = (els.token.value||'').trim();
      if(t) await api('/auth', { method:'POST', body: JSON.stringify({ token: t }) });
      const me = await api('/me');
      note(els.connectMsg, 'Connected.', 'note-ok');
      els.me.textContent = `Signed in as ${me.username}${me.discriminator?('#'+me.discriminator):''} (${me.id})`;
      setBadge('Connected','ok'); toast('Connected to bot');
    }catch(e){
      console.error(e);
      note(els.connectMsg, 'Connect failed: ' + e.message, 'note-err');
      setBadge('Disconnected','err');
    }
  });

  els.disconnect.addEventListener('click', async ()=>{
    try{ await api('/auth', { method:'DELETE' }); }catch(_e){}
    setBadge('Disconnected'); els.me.textContent=''; note(els.connectMsg,'Disconnected.','muted');
    // clear UI state
    els.dmSelect.innerHTML=''; els.dmList.innerHTML=''; els.dmText.value='';
    els.guildSelect.innerHTML=''; els.channelSelect.innerHTML=''; els.guildList.innerHTML=''; els.guildText.value='';
    toast('Disconnected');
  });

  // ---- Presence
  els.updatePresence.addEventListener('click', async ()=>{
    note(els.presenceMsg,'Updating…','muted');
    try{
      const body = {
        status: els.presence.value,
        activity_type: parseInt(els.activityType.value,10),
        activity_text: els.activityText.value.trim()
      };
      await api('/status', { method:'POST', body: JSON.stringify(body) });
      note(els.presenceMsg,'Presence updated.','note-ok');
      toast('Presence updated');
    }catch(e){
      note(els.presenceMsg,'Failed: '+e.message,'note-err');
    }
  });

  // ---- DMs
  els.loadDMs.addEventListener('click', async ()=>{
    note(els.dmMsg,'Loading…','muted'); els.dmSelect.innerHTML=''; els.dmList.innerHTML='';
    try{
      const dms = await api('/dms');
      dms.forEach(ch=>{
        const label = (ch.recipients && ch.recipients[0]) ? `${ch.recipients[0].username} (${ch.id})` : `DM ${ch.id}`;
        const opt = new Option(label, ch.id); els.dmSelect.add(opt);
        const li = document.createElement('li');
        li.className='item'; li.innerHTML = `<div><strong>${label}</strong><div class="small muted">Type: ${ch.type}</div></div><button class="ghost small">Select</button>`;
        li.querySelector('button').addEventListener('click', ()=>{ els.dmSelect.value = ch.id; });
        els.dmList.appendChild(li);
      });
      if(!dms.length) note(els.dmMsg,'No DM channels known yet. Open a DM with the bot first.','muted');
      else note(els.dmMsg,`Loaded ${dms.length} DM channel(s).`,'note-ok');
    }catch(e){
      note(els.dmMsg,'Failed: '+e.message,'note-err');
    }
  });

  document.getElementById('sendDM').addEventListener('click', async ()=>{
    note(els.dmMsg,''); const id = els.dmSelect.value; const content = els.dmText.value.trim();
    if(!id) return note(els.dmMsg,'Pick a DM channel first.','note-warn');
    if(!content) return note(els.dmMsg,'Type a message.','note-warn');
    try{
      await api(`/channels/${id}/messages`, { method:'POST', body: JSON.stringify({ content }) });
      note(els.dmMsg,'DM sent.','note-ok'); els.dmText.value=''; toast('DM sent');
    }catch(e){ note(els.dmMsg,'Failed: '+e.message,'note-err'); }
  });

  // ---- Guilds & Channels
  els.loadGuilds.addEventListener('click', async ()=>{
    note(els.guildMsg,'Loading servers…','muted'); els.guildSelect.innerHTML=''; els.channelSelect.innerHTML=''; els.guildList.innerHTML='';
    try{
      const guilds = await api('/guilds');
      guilds.forEach(g=>{
        els.guildSelect.add(new Option(`${g.name} (${g.id})`, g.id));
        const li = document.createElement('li');
        li.className='item'; li.innerHTML = `<div><strong>${g.name}</strong><div class="small muted">ID: ${g.id}</div></div><button class="ghost small">Channels</button>`;
        li.querySelector('button').addEventListener('click', ()=>{ els.guildSelect.value = g.id; loadChannels(g.id); });
        els.guildList.appendChild(li);
      });
      if(guilds[0]) loadChannels(guilds[0].id);
      if(!guilds.length) note(els.guildMsg,'No servers found (invite the bot).','muted');
      else note(els.guildMsg,`Loaded ${guilds.length} server(s).`,'note-ok');
    }catch(e){ note(els.guildMsg,'Failed: '+e.message,'note-err'); }
  });

  async function loadChannels(gid){
    els.channelSelect.innerHTML='';
    try{
      const chans = await api(`/guilds/${gid}/channels`);
      const textChans = chans.filter(c=> c.type===0);
      textChans.forEach(c=> els.channelSelect.add(new Option(`#${c.name} (${c.id})`, c.id)));
      if(!textChans.length) els.channelSelect.add(new Option('No text channels',''));
    }catch(e){ note(els.guildMsg,'Load channels failed: '+e.message,'note-err'); }
  }
  els.guildSelect.addEventListener('change', e=> loadChannels(e.target.value));

  els.sendGuild.addEventListener('click', async ()=>{
    note(els.guildMsg,''); const chId = els.channelSelect.value; const content = els.guildText.value.trim();
    if(!chId) return note(els.guildMsg,'Pick a text channel.','note-warn');
    if(!content) return note(els.guildMsg,'Type a message.','note-warn');
    try{
      await api(`/channels/${chId}/messages`, { method:'POST', body: JSON.stringify({ content }) });
      note(els.guildMsg,'Message sent.','note-ok'); els.guildText.value=''; toast('Channel message sent');
    }catch(e){ note(els.guildMsg,'Failed: '+e.message,'note-err'); }
  });

  // ---- Clear UI
  els.clear.addEventListener('click', ()=>{
    els.token.value=''; els.me.textContent=''; setBadge('Disconnected');
    ['connectMsg','presenceMsg','dmMsg','guildMsg'].forEach(id=> note(els[id],'',''));
    els.dmSelect.innerHTML=''; els.dmList.innerHTML=''; els.dmText.value='';
    els.guildSelect.innerHTML=''; els.channelSelect.innerHTML=''; els.guildList.innerHTML=''; els.guildText.value='';
  });
})();
</script>

<!--
This frontend expects the backend routes from the FastAPI+discord.py server:

POST   /api/auth                 { token }
DELETE /api/auth
GET    /api/me
GET    /api/dms
GET    /api/guilds
GET    /api/guilds/:id/channels
POST   /api/channels/:id/messages  { content }
POST   /api/status                 { status, activity_type, activity_text }

Security: keep the real token on the server (env var or POST /api/auth). This page does not persist tokens.
-->
</body>
</html>
