<!doctype html>
<html lang="en">
<head>
  <!-- Primary SEO -->
<title>Gomega AI — Official Site</title>
<meta name="description" content="Gomega AI is your fast, animated, plus-powered assistant. Try thinking mode, smarter chat, and Gomega integrations — all on the official site.">
<link rel="canonical" href="https://gomega.watch/ai">

<!-- Viewport & robots -->
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="robots" content="index,follow,max-image-preview:large">

<!-- Favicons -->
<link rel="icon" href="/favicon.ico">
<link rel="apple-touch-icon" href="/apple-touch-icon.png">

<!-- Open Graph -->
<meta property="og:type" content="website">
<meta property="og:site_name" content="Gomega">
<meta property="og:title" content="Gomega AI — Official Site">
<meta property="og:description" content="Thinking mode, animations, and plus features. Meet Gomega AI.">
<meta property="og:url" content="https://gomega.watch/ai">
<meta property="og:image" content="https://gomega.watch/og/gomega-ai-1200x630.png">

<!-- Twitter -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="Gomega AI — Official Site">
<meta name="twitter:description" content="Thinking mode, animations, and plus features. Meet Gomega AI.">
<meta name="twitter:image" content="https://gomega.watch/og/gomega-ai-1200x630.png">

<!-- JSON-LD: Organization + WebSite + WebPage -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@graph": [
    {
      "@type": "Organization",
      "@id": "https://gomega.watch/#org",
      "name": "Gomega",
      "url": "https://gomega.watch/",
      "logo": "https://gomega.watch/og/gomega-logo-512.png",
      "sameAs": [
        "https://x.com/<your_handle>",
        "https://www.instagram.com/<your_handle>",
        "https://www.youtube.com/@<your_handle>"
      ]
    },
    {
      "@type": "WebSite",
      "@id": "https://gomega.watch/#website",
      "url": "https://gomega.watch/",
      "name": "Gomega",
      "publisher": { "@id": "https://gomega.watch/#org" },
      "inLanguage": "en",
      "potentialAction": {
        "@type": "SearchAction",
        "target": "https://gomega.watch/search?q={search_term_string}",
        "query-input": "required name=search_term_string"
      }
    },
    {
      "@type": "WebPage",
      "@id": "https://gomega.watch/ai#webpage",
      "url": "https://gomega.watch/ai",
      "name": "Gomega AI — Official Site",
      "isPartOf": { "@id": "https://gomega.watch/#website" },
      "about": { "@id": "https://gomega.watch/#org" },
      "description": "Gomega AI with thinking mode, animations, and plus features.",
      "inLanguage": "en",
      "primaryImageOfPage": "https://gomega.watch/og/gomega-ai-1200x630.png"
    },
    {
      "@type": "FAQPage",
      "@id": "https://gomega.watch/ai#faq",
      "mainEntity": [
        {
          "@type": "Question",
          "name": "What is Gomega AI?",
          "acceptedAnswer": {
            "@type": "Answer",
            "text": "Gomega AI is a fast, animated assistant with thinking modes and plus features built for creators and teams."
          }
        },
        {
          "@type": "Question",
          "name": "Is there a Plus version?",
          "acceptedAnswer": {
            "@type": "Answer",
            "text": "Yes. Gomega AI Plus unlocks Think Harder mode, additional daily limits, and advanced features."
          }
        }
      ]
    }
  ]
}
</script>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Gomega AI (BETA) — Gomega Smart AI</title>
<link rel="sitemap" type="application/xml" href="/sitemap.xml">
<style>
  :root{
    --bg1:#071021; --bg2:#0b1220; --accent:#34d3ff; --accent2:#7c3aed; --muted:#94a3b8;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;
    background:
      radial-gradient(900px 400px at 10% 10%, rgba(56,189,248,0.04), transparent),
      linear-gradient(180deg,var(--bg1),var(--bg2));
    color:#e6eef6; min-height:100vh; display:flex; flex-direction:column; align-items:center; padding:0 18px 18px; overflow-x:hidden;
  }

  /* ✨ animated aurora & particles */
  .bg-aurora{
    position:fixed; inset:-10% -10% auto -10%; height:60vh; pointer-events:none; filter: blur(40px) saturate(120%);
    background:
      radial-gradient(600px 220px at 20% 10%, rgba(124,58,237,0.20), transparent 60%),
      radial-gradient(500px 260px at 70% 0%, rgba(52,211,255,0.18), transparent 60%),
      radial-gradient(480px 240px at 40% 30%, rgba(56,189,248,0.12), transparent 60%);
    animation: floaty 18s ease-in-out infinite alternate;
    opacity:.9;
  }
  @keyframes floaty {
    0% { transform: translateY(-10px) scale(1); filter:blur(40px) saturate(120%); }
    100%{ transform: translateY(10px) scale(1.04); filter:blur(44px) saturate(140%); }
  }
  .sparkles{
    position:fixed; inset:0; pointer-events:none; opacity:.3;
    background-image: radial-gradient(2px 2px at 10% 20%, rgba(255,255,255,.4), transparent),
                      radial-gradient(2px 2px at 80% 30%, rgba(255,255,255,.4), transparent),
                      radial-gradient(2px 2px at 30% 70%, rgba(255,255,255,.4), transparent),
                      radial-gradient(2px 2px at 60% 60%, rgba(255,255,255,.4), transparent);
    animation: drift 22s linear infinite;
  }
  @keyframes drift { to { transform: translate3d(8px,-8px,0) } }

  /* Site nav + hero additions */
  .site-nav{
    position:sticky; top:0; z-index:50; width:100%; max-width:1200px; margin:0 auto 8px;
    display:flex; align-items:center; justify-content:space-between; padding:10px 12px;
    background:rgba(9,15,28,.55); backdrop-filter: blur(8px); border:1px solid rgba(255,255,255,.04); border-radius:14px;
  }
  .site-nav a{ color:#d9f4ff; text-decoration:none; font-size:14px; margin:0 10px }
  .site-nav a:hover{ text-decoration:underline }
  .cta{ padding:8px 12px; border-radius:10px; background:linear-gradient(90deg,var(--accent),var(--accent2)); color:#062; font-weight:700 }

  .hero{
    width:100%; max-width:1200px; margin:12px auto 18px; padding:24px; border-radius:16px;
    background:linear-gradient(120deg, rgba(52,211,255,.08), rgba(124,58,237,.08));
    border:1px solid rgba(255,255,255,.06);
    display:grid; grid-template-columns: 1.2fr 1fr; gap:18px; align-items:center;
  }
  .hero h2{ margin:0 0 8px; font-size:28px; color:#e6fbff }
  .hero p{ margin:0; color:#c6d6e6 }
  .hero video, .hero img{ width:100%; border-radius:12px; border:1px solid rgba(255,255,255,.06) }
  @media (max-width:980px){ .hero{ grid-template-columns:1fr } }

  .topbar{ width:100%; max-width:1150px; display:flex; justify-content:space-between; align-items:center; gap:12px; margin:12px auto 12px; }
  .brand{ display:flex; gap:12px; align-items:center; }
  .logo{ width:56px; height:56px; border-radius:12px; background:linear-gradient(135deg,var(--accent),var(--accent2)); display:flex; align-items:center; justify-content:center; transform:rotate(-8deg) }
  .logo b{ color:#062; font-size:20px }
  h1{ margin:0; font-size:20px; color:#e6fbff; }
  .meta{ color:var(--muted); font-size:13px }

  .container{ width:100%; max-width:1150px; display:grid; grid-template-columns: 1fr 380px; gap:18px; align-items:start; }
  .chat-area{ background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.02)); padding:18px; border-radius:14px; min-height:640px; max-height:80vh; overflow:auto; border:1px solid rgba(255,255,255,0.02); position:relative }
  .messages{ display:flex; flex-direction:column; gap:12px; padding-right:6px }
  .bubble{ max-width:82%; padding:12px 14px; border-radius:12px; line-height:1.45; position:relative; animation: slideUp .28s ease, glowIn .8s ease }
  .bubble.user{ background: linear-gradient(90deg,#0b6b4c,#064e3b); color:#d7fff0; align-self:flex-end; border-bottom-right-radius:6px; }
  .bubble.ai{ background: linear-gradient(90deg,#0b1020,#151827); color:#e6eef6; align-self:flex-start; border-bottom-left-radius:6px; }
  .bubble:hover{ box-shadow:0 0 0 1px rgba(255,255,255,.03) inset, 0 8px 30px rgba(124,58,237,.08) }
  @keyframes slideUp { from{opacity:0; transform:translateY(8px)} to{opacity:1; transform:none} }
  @keyframes glowIn { from{box-shadow:0 0 0 rgba(0,0,0,0)} to{box-shadow:0 0 0 1px rgba(255,255,255,.02) inset} }

  .controls{ display:flex; gap:10px; align-items:center; margin-top:10px; }
  input.prompt{ flex:1; padding:12px; border-radius:10px; background:transparent; color:#e6eef6; border:1px solid rgba(255,255,255,0.03); outline:none; font-size:15px; transition:border-color .2s, box-shadow .2s }
  input.prompt:focus{ border-color: rgba(52,211,255,.3); box-shadow:0 0 0 3px rgba(52,211,255,.1) }
  select{ padding:10px; border-radius:8px; background:transparent; color:#e6eef6; border:1px solid rgba(255,255,255,0.03) }
  button.primary{ padding:12px 18px; border-radius:10px; border:none; background:linear-gradient(90deg,var(--accent),var(--accent2)); color:#062; cursor:pointer; font-weight:700; transition: transform .08s ease }
  button.primary:active{ transform: translateY(1px) scale(.995) }
  button.ghost{ padding:8px 10px; border-radius:10px; border:1px solid rgba(255,255,255,0.03); background:transparent; color:var(--muted); cursor:pointer }
  button.small{ padding:6px 8px; border-radius:8px; border:1px solid rgba(255,255,255,0.03); background:transparent; color:var(--muted); cursor:pointer }
  .sidebar{ padding:18px; border-radius:14px; background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.02)); border:1px solid rgba(255,255,255,0.02); min-height:640px; display:flex; flex-direction:column; gap:12px; }
  .card{ padding:12px; border-radius:10px; background:transparent; border:1px solid rgba(255,255,255,0.02) }
  .models{ display:flex; flex-direction:column; gap:8px; }
  .modelRow{ display:flex; justify-content:space-between; align-items:center; gap:8px; padding:8px; border-radius:8px; background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.02)); }
  .small{ font-size:13px; color:var(--muted) }
  .progress{ height:8px; background:rgba(255,255,255,0.03); border-radius:8px; overflow:hidden; width:100% }
  .bar{ height:100%; width:0%; background:linear-gradient(90deg,var(--accent),var(--accent2)); transition:width 180ms linear, filter .2s ease }
  .bar.pulse{ filter: drop-shadow(0 0 8px rgba(124,58,237,.35)); }
  .photoGrid{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px }
  .photoCard{ width:86px; height:66px; border-radius:6px; overflow:hidden; background:#000; display:flex; align-items:center; justify-content:center; position:relative }
  .photoCard img{ width:100%; height:100%; object-fit:cover }
  .photoActions{ position:absolute; bottom:6px; left:6px; right:6px; display:flex; gap:6px; justify-content:center }
  .explain{ margin-top:8px; font-size:13px; color:var(--muted); border-top:1px dashed rgba(255,255,255,0.03); padding-top:8px }
  .typingDots{ display:inline-block; margin-left:6px; }
  .typingDots span{ display:inline-block; width:6px; height:6px; margin:0 2px; border-radius:50%; background:rgba(255,255,255,0.35); opacity:0.6; animation: blink 1s infinite; transform:translateY(0); }
  .typingDots span:nth-child(2){ animation-delay:0.15s }
  .typingDots span:nth-child(3){ animation-delay:0.3s }
  @keyframes blink { 0%{ opacity:0.2; transform:translateY(0)} 50%{ opacity:1; transform:translateY(-4px)} 100%{ opacity:0.2; transform:translateY(0)} }

  .badgePlus{ display:inline-block; padding:4px 8px; border-radius:10px; background:linear-gradient(90deg,#ffd166,#ff6b6b); color:#081024; font-weight:700; font-size:12px; margin-left:8px }
  .plusNote{ font-size:12px; color:var(--muted); margin-top:6px }

  /* New: chats list + memory + footer + sections */
  .chatsList{ display:flex; flex-direction:column; gap:8px; max-height:220px; overflow:auto; margin-top:8px }
  .chatItem{ display:flex; align-items:center; justify-content:space-between; gap:8px; padding:8px; border-radius:8px; background:rgba(255,255,255,.02); border:1px solid rgba(255,255,255,.03); cursor:pointer }
  .chatItem.active{ outline:2px solid rgba(52,211,255,.35) }
  .chatItem .title{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:220px }
  .chatItem .actions button{ margin-left:6px }
  .chatToolbar{ display:flex; gap:8px; margin-top:8px; flex-wrap:wrap }
  .memoryList{ display:flex; flex-direction:column; gap:6px; max-height:160px; overflow:auto; margin-top:6px }
  .memoryRow{ display:flex; align-items:center; justify-content:space-between; gap:8px; padding:6px 8px; border-radius:8px; background:rgba(255,255,255,.02); border:1px solid rgba(255,255,255,.03) }
  .footer{ width:100%; max-width:1200px; margin:28px auto 0; padding:18px; color:#a8b6c6; font-size:13px; border-top:1px solid rgba(255,255,255,.06) }
  .footer .row{ display:flex; gap:12px; justify-content:space-between; flex-wrap:wrap }
  .footer a{ color:#cfe9ff; text-decoration:none }
  .footer a:hover{ text-decoration:underline }

  .site-sections{ width:100%; max-width:1200px; margin:18px auto 0; display:grid; grid-template-columns: repeat(12, 1fr); gap:18px }
  .section{ grid-column: span 12; background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(0,0,0,.02)); border:1px solid rgba(255,255,255,.06); border-radius:14px; padding:18px }
  .section h3{ margin:0 0 8px }
  .cols{ display:grid; grid-template-columns:1fr 1fr; gap:12px }
  @media (max-width:980px){ .cols{ grid-template-columns:1fr } }

  @media (max-width:980px){
    .container{ grid-template-columns:1fr }
    .sidebar{ order:2 }
    .chat-area{ order:1 }
  }
</style>
</head>
<body>
<div class="bg-aurora"></div>
<div class="sparkles"></div>

<!-- New sticky site navigation (added) -->
<nav class="site-nav">
  <div style="display:flex;align-items:center;gap:10px">
    <div class="logo" style="width:36px;height:36px;transform:none"><b>G</b></div>
    <strong>Gomega</strong>
  </div>
  <div>
    <a href="#home">Home</a>
    <a href="#about">About</a>
    <a href="#products">Products</a>
    <a href="#blog">Blog</a>
    <a href="#contact">Contact</a>
    <a class="cta" href="#ai">Launch AI</a>
  </div>
</nav>

<!-- Hero section (added) -->
<section id="home" class="hero">
  <div>
    <h2>AI‑powered answers for creators & teams</h2>
    <p>Gomega AI blends fast chat, animated UI, and a Plus tier with Think Harder mode. Build, learn, and ship faster.</p>
    <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
      <a class="cta" href="#ai">Get Started</a>
      <a href="#products">See features</a>
    </div>
  </div>
  <div>
    <img src="https://gomega.watch/og/gomega-ai-1200x630.png" alt="Gomega AI preview">
  </div>
</section>

<div class="topbar" id="ai">
  <div class="brand">
    <div class="logo"><b>G</b></div>
    <div>
      <h1>Gomega AI</h1>
      <div class="meta">&nbsp;</div>
    </div>
  </div>
  <div style="text-align:right">
    <div class="meta">Local: <span id="localTime">—</span></div>
    <div class="meta">Last: <span id="lastFetch">—</span></div>
  </div>
</div>

<div class="container">
  <div class="chat-area">
    <div class="messages" id="messages"></div>
    <div class="controls" style="margin-top:12px">
      <input id="prompt" class="prompt" placeholder="Ask anything"/>
      <select id="modelSelect" title="Choose model"></select>
      <button id="askBtn" class="primary">Ask</button>
      <button id="setKeyBtn" class="ghost">Set Key</button>
    </div>
    <div style="margin-top:8px; display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
      <label class="small">Thinking</label><input type="checkbox" id="thinkingToggle"/>
      <button id="thinkHarderBtn" class="small">Think harder (3/day)</button>
      <label class="small" style="margin-left:8px">Strict</label><input type="checkbox" id="strictToggle"/>
      <button id="clearBtn" class="ghost" style="margin-left:auto">Clear UI</button>
    </div>
  </div>

  <div class="sidebar">
    <!-- NEW: Chats manager -->
    <div class="card">
      <strong>Chats</strong>
      <div class="chatToolbar">
        <button id="newChatBtn" class="small">New chat</button>
        <button id="renameChatBtn" class="small">Rename</button>
        <button id="deleteChatBtn" class="small">Delete</button>
        <button id="exportChatBtn" class="small">Export</button>
        <button id="exportAllBtn" class="small">Export all</button>
        <label class="small" style="display:inline-flex;align-items:center;gap:6px">Import
          <input type="file" id="importChatsInput" accept="application/json" class="small" style="width:140px">
        </label>
      </div>
      <div id="chatsList" class="chatsList"></div>
    </div>

    <div class="card">
      <strong>Models</strong>
      <div class="models" id="modelList"></div>
      <div style="margin-top:8px">
        <input id="premiumCodeInput" placeholder="Enter plus code(s) — separated by commas" style="width:100%;padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04)">
        <button id="applyCodeBtn" class="small" style="margin-top:6px">Apply</button>
        <div class="plusNote">Become a Plus member? Add a valid code to unlock extra models & limits.</div>
      </div>
    </div>

    <div class="card">
      <strong>Thinking & progress</strong>
      <div style="display:flex; gap:8px; align-items:center; margin-top:8px;">
        <div class="small">Status:</div><div id="thinkingBadge" class="small">Idle</div>
      </div>
      <div style="margin-top:8px" class="progress"><div id="progressBar" class="bar"></div></div>
      <div style="margin-top:8px" class="small">Confidence: <span id="confidence">—</span></div>
      <div class="explain" id="lastAction">No action yet.</div>
    </div>

    <div class="card">
      <strong>Photos (BETA)</strong>
      <div style="margin-top:8px; display:flex; gap:8px; align-items:center;">
        <input type="file" id="photoInput" accept="image/*"> <button id="addPhotoBtn" class="ghost">Add</button>
      </div>
      <div class="small" style="margin-top:8px">Daily sends left: <span id="photoQuota">5</span></div>
      <div class="photoGrid" id="photoGrid"></div>
      <div class="small" style="margin-top:8px">Photos stored locally; Plus gets infinite sends. The UI will try to upload images to OpenAI (if you set an API key and CORS allows it) or fall back to embedding images.</div>
    </div>

    <div class="card">
      <strong>Session memory</strong>
      <div id="sessionList" class="small" style="margin-top:8px">No messages yet.</div>
      <div style="margin-top:8px"><button id="clearSession" class="ghost">Clear Memory</button></div>
    </div>

    <!-- NEW: Long‑term memory (persistent) -->
    <div class="card">
      <strong>Long‑term memory</strong>
      <div style="display:flex;gap:8px;margin-top:8px">
        <input id="memoryInput" placeholder="e.g., My name is Alex; I like TypeScript" style="flex:1;padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,.06);color:#e6eef6">
        <button id="addMemoryBtn" class="small">Remember</button>
      </div>
      <div id="memoryList" class="memoryList"></div>
      <div class="small" style="margin-top:6px">Tip: memory is sent to the AI each time for better context.</div>
    </div>
  </div>
</div>

<!-- New site sections (About, Products, Blog, Contact, Legal) -->
<div class="site-sections">
  <section id="about" class="section">
    <h3>About Gomega</h3>
    <div class="cols">
      <div>
        <p>Founded in 2025, Gomega AI empowers creators and teams with a playful, fast assistant featuring animated UI, image tools, and a Plus tier for power users.</p>
        <p>Mission: make high‑quality AI experiences accessible, delightful, and safe.</p>
      </div>
      <div>
        <ul class="small">
          <li>HQ: Internet‑native</li>
          <li>Support: <a href="mailto:gomegaassist@gmail.com">gomegaassist@gmail.com</a></li>
          <li>Social: <a href="https://x.com/" target="_blank" rel="noopener">X/Twitter</a> • <a href="https://www.linkedin.com/" target="_blank" rel="noopener">LinkedIn</a></li>
        </ul>
      </div>
    </div>
  </section>

  <section id="products" class="section">
    <h3>Products & Features</h3>
    <div class="cols">
      <div>
        <h4>Gomega AI</h4>
        <ul>
          <li>Thinking mode + “Think harder” (3/day)</li>
          <li>Multiple chats with save/switch/export</li>
          <li>Long‑term memory per browser</li>
          <li>Image upload (best effort)</li>
        </ul>
      </div>
      <div>
        <h4>Plus</h4>
        <ul>
          <li>Unlock premium models (codes)</li>
          <li>Higher limits & faster typing</li>
          <li>Extra search expansion</li>
        </ul>
      </div>
    </div>
  </section>

  <section id="blog" class="section">
    <h3>Blog</h3>
    <p class="small">Coming soon — product notes, guides, and behind‑the‑scenes.</p>
  </section>

  <section id="contact" class="section">
    <h3>Contact & Support</h3>
    <div class="cols">
      <form method="POST" action="mailto:gomegaassist@gmail.com" enctype="text/plain">
        <div style="display:grid;gap:8px">
          <input name="name" placeholder="Your name" required style="padding:10px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,.12);color:#e6eef6">
          <input name="email" type="email" placeholder="Your email" required style="padding:10px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,.12);color:#e6eef6">
          <textarea name="message" placeholder="How can we help?" rows="5" required style="padding:10px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,.12);color:#e6eef6"></textarea>
          <button class="primary" type="submit">Send</button>
        </div>
      </form>
      <div>
        <p>Email: <a href="mailto:gomegaassist@gmail.com">gomegaassist@gmail.com</a></p>
        <p>Phone: <a href="tel:+1-000-000-0000">+1 (000) 000‑0000</a></p>
        <p class="small">We aim to respond within 1–2 business days.</p>
      </div>
    </div>
  </section>

  <section id="privacy" class="section">
    <h3>Privacy Policy</h3>
    <p class="small">We store chat and memory locally in your browser unless you explicitly export them. Review your browser storage settings to manage persistence.</p>
  </section>
  <section id="terms" class="section">
    <h3>Terms of Service</h3>
    <p class="small">Use Gomega AI responsibly. Do not submit sensitive information you do not wish to store locally. Third‑party model use is subject to their terms.</p>
  </section>
  <section id="cookies" class="section">
    <h3>Cookie Policy</h3>
    <p class="small">We use localStorage to remember preferences, chats, and memory. No tracking cookies are set by default.</p>
  </section>
</div>

<footer class="footer">
  <div class="row">
    <div>© 2025 Gomega AI. All rights reserved.</div>
    <div>
      <a href="#privacy">Privacy</a> •
      <a href="#terms">Terms</a> •
      <a href="#cookies">Cookies</a> •
      <a href="/sitemap.xml">Sitemap</a>
    </div>
  </div>
</footer>

<script>
/* === OWNER API KEY CONFIGURATION (unchanged from user's code) === */
const OWNER_API_KEY_RAW = 'sk-proj-esQZvuHfktHXvSoEtfPRy-IZuDRXYWSTrtphEqUXFlTds,1tOHtjZzg3daCpD_VzKs7yT0I8p_HT3BlbkFJFlcclxKg8g_R6gscPp1gekMQXtDmVkwzkKY6Y4LJtSGfDxC7EMVWj16dzS9sM-dz3TaRb52zkA';

/* ---------- Basic UI refs ---------- */
const messagesEl = document.getElementById('messages');
const promptEl = document.getElementById('prompt');
const askBtn = document.getElementById('askBtn');
const setKeyBtn = document.getElementById('setKeyBtn');
const modelSelect = document.getElementById('modelSelect');
const modelListEl = document.getElementById('modelList');
const thinkingToggle = document.getElementById('thinkingToggle');
const strictToggle = document.getElementById('strictToggle');
const thinkingBadge = document.getElementById('thinkingBadge');
const progressBar = document.getElementById('progressBar');
const lastAction = document.getElementById('lastAction');
const confidenceEl = document.getElementById('confidence');
const lastFetchEl = document.getElementById('lastFetch');
const photoInput = document.getElementById('photoInput');
const addPhotoBtn = document.getElementById('addPhotoBtn');
const photoGrid = document.getElementById('photoGrid');
const photoQuotaEl = document.getElementById('photoQuota');
const sessionListEl = document.getElementById('sessionList');
const clearSessionBtn = document.getElementById('clearSession');
const premiumCodeInput = document.getElementById('premiumCodeInput');
const applyCodeBtn = document.getElementById('applyCodeBtn');
const thinkHarderBtn = document.getElementById('thinkHarderBtn');

/* NEW: chats & memory refs */
const newChatBtn = document.getElementById('newChatBtn');
const renameChatBtn = document.getElementById('renameChatBtn');
const deleteChatBtn = document.getElementById('deleteChatBtn');
const exportChatBtn = document.getElementById('exportChatBtn');
const exportAllBtn = document.getElementById('exportAllBtn');
const importChatsInput = document.getElementById('importChatsInput');
const chatsListEl = document.getElementById('chatsList');
const memoryInput = document.getElementById('memoryInput');
const addMemoryBtn = document.getElementById('addMemoryBtn');
const memoryListEl = document.getElementById('memoryList');

let session = [];    // mirrors active chat messages for rendering
let photos = [];
let typingLocked = false;
let premiumUnlocked = false; // Plus
let premiumCodes = [];
let thinkHarderActive = false;

/* ---------- sanitize/strip commas helper ---------- */
function normalizeKey(raw){ if(!raw) return ''; return raw.replace(/,/g, '').trim(); }
const OWNER_API_KEY = normalizeKey(OWNER_API_KEY_RAW);
if(OWNER_API_KEY){ try{ setKeyBtn.style.display = 'none'; }catch(e){} } else { try{ setKeyBtn.style.display = ''; }catch(e){} }

/* ---------- Models ---------- */
const MODEL_CONFIG = {
  'gomega-v10': { label: 'Gomega V10 (Plus)', openai: 'gpt-4o', speed:6, smart:true, verb:2.0, premium: true },
  'gomega-v9' : { label: 'Gomega V9 (Plus)',  openai: 'gpt-4o', speed:8, smart:true, verb:1.9, premium: true },
  'gomega-v8' : { label: 'Gomega V8 (Plus)',  openai: 'gpt-4o', speed:10, smart:true, verb:1.6, premium: true },
  'gomega-v6' : { label: 'Gomega V6 (Plus)',  openai: 'gpt-4o', speed:12, smart:true, verb:1.5, premium: true },
  'gomega-v7' : { label: 'Gomega V7',        openai: 'gpt-4o-mini', speed:41, smart:true,  verb:1.0, premium: false },
  'gomega-v7mini':{ label: 'Gomega V7-mini',  openai: 'gpt-3.5-turbo', speed:38, smart:false, verb:0.5, premium: false },
  'gomega-v5' : { label: 'Gomega V5',        openai: 'gpt-3.5-turbo', speed:30, smart:false, verb:1.0, premium:false },
  'mathmaster': { label: 'MathMaster',        openai: 'gpt-3.5-turbo', speed:30, smart:true,  verb:0.2, premium:false }
};
let currentModelKey = 'gomega-v7';

/* ---- UI helpers (kept + used by chats) ---- */
function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
function addBubble(role, html){
  const el = document.createElement('div');
  el.className = 'bubble ' + (role==='user' ? 'user' : 'ai');
  el.innerHTML = html;
  messagesEl.appendChild(el);
  messagesEl.scrollTop = messagesEl.scrollHeight;
  return el;
}
function updateSessionUI(){ sessionListEl.innerHTML = session.slice(-6).map(m=>`<div class="small"><strong>${escapeHtml(m.role)}</strong>: ${escapeHtml(m.text).slice(0,140)}</div>`).join('') || 'No messages yet.'; }
function setProgress(p){ progressBar.style.width = Math.max(3, Math.min(100,p)) + '%'; if(p>0 && p<100) progressBar.classList.add('pulse'); else progressBar.classList.remove('pulse'); }
function setThinkingText(t){ thinkingBadge.textContent = t; lastAction.textContent = t; }
function setTypingLocked(v){
  typingLocked = v; promptEl.disabled = v; askBtn.disabled = v; setKeyBtn.disabled = v; thinkHarderBtn.disabled = v;
  if(v){ promptEl.classList.add('disabled'); askBtn.classList.add('disabled'); setKeyBtn.classList.add('disabled'); }
  else { promptEl.classList.remove('disabled'); askBtn.classList.remove('disabled'); setKeyBtn.classList.remove('disabled'); }
}
function addTypingIndicator(container){ const dots = document.createElement('span'); dots.className = 'typingDots'; dots.innerHTML = '<span></span><span></span><span></span>'; container.appendChild(dots); return dots; }
function removeTypingIndicator(dotsEl){ if(dotsEl && dotsEl.parentNode) dotsEl.parentNode.removeChild(dotsEl); }
async function typeTextInto(node, text, speed){
  const dots = node.querySelector('.typingDots'); if(dots) removeTypingIndicator(dots);
  node.innerHTML = '';
  for(let i=0;i<text.length;i++){
    const ch = text[i];
    node.innerHTML = escapeHtml(text.slice(0,i+1)).replace(/\n/g,'<br>');
    messagesEl.scrollTop = messagesEl.scrollHeight;
    const variability = 0.75 + Math.random()*0.6;
    let delay = Math.max(3, Math.round(speed * variability));
    if(/[,;]/.test(ch)) delay += 80;
    if(/[.!?]/.test(ch)) delay += 160;
    await new Promise(r=>setTimeout(r, delay));
  }
}

/* ---------- Math/geometry engine (kept) ---------- */
function tokenize(expr){ const s = String(expr); const tokens = []; const isNumChar = c => /[0-9.]/.test(c); const isAlpha = c => /[a-zA-Z]/.test(c); let i=0;
  while(i<s.length){ const c = s[i]; if(/\s/.test(c)){ i++; continue; } if(c==='+'||c==='-'||c==='*'||c==='/'||c==='^'||c==='('||c===')'){ tokens.push({type:c, val:c}); i++; continue; }
    if(isNumChar(c)){ let j=i; while(j<s.length && /[0-9.]/.test(s[j])) j++; tokens.push({type:'num', val: s.slice(i,j)}); i=j; continue; }
    if(isAlpha(c)){ let j=i; while(j<s.length && /[a-zA-Z0-9_]/.test(s[j])) j++; tokens.push({type:'id', val: s.slice(i,j)}); i=j; continue; } i++; }
  const out = []; for(let k=0;k<tokens.length;k++){ out.push(tokens[k]); if(k+1<tokens.length){ const a = tokens[k], b = tokens[k+1];
    const aok = (a.type==='num' || a.type==='id' || a.type===')'); const bok = (b.type==='id' || b.type==='num' || b.type==='('); if(aok && bok) out.push({type:'*', val:'*'}); } } return out; }
function makeTerm(coeff, vars){ return {coeff: coeff, vars: Object.assign({}, vars)}; }
function termKey(vars){ const keys = Object.keys(vars).filter(k=>vars[k]!==0).sort(); if(keys.length===0) return ''; return keys.map(k=>`${k}^${vars[k]}`).join('*'); }
function multiplyVars(a,b){ const res = Object.assign({}, a); for(const k in b) res[k] = (res[k]||0) + b[k]; for(const k in res) if(res[k]===0) delete res[k]; return res; }
function parseExpression(tokens){ let pos=0; function peek(){ return tokens[pos] || null; } function consume(t){ const cur = tokens[pos]; if(!cur) return null; if(t && cur.type!==t) return null; pos++; return cur; }
  function parsePrimary(){ const cur=peek(); if(!cur) return [{coeff:0, vars:{}}]; if(cur.type==='num'){ consume('num'); return [makeTerm(Number(cur.val), {})]; }
    if(cur.type==='id'){ consume('id'); const vars={}; vars[cur.val]=1; return [makeTerm(1, vars)]; } if(cur.type==='('){ consume('('); const expr = parseAddSub(); consume(')'); return expr; } consume(); return [{coeff:0, vars:{}}]; }
  function parsePow(){ let base = parsePrimary(); while(peek() && peek().type==='^'){ consume('^'); const right = peek(); if(right && right.type==='num'){ const exp = Number(consume('num').val);
      let raised = []; for(const t of base){ let seed = [makeTerm(1, {})]; for(let e=0;e<exp;e++) seed = multiplyTermLists(seed, [t]); for(const s of seed) raised.push(s); } base = raised; } else break; } return base; }
  function parseMulDiv(){ let left = parsePow(); while(peek() && (peek().type==='*' || peek().type=='/')){ const op = consume().type; const right = parsePow(); if(op==='*') left = multiplyTermLists(left, right);
      else { if(right.length===1 && Object.keys(right[0].vars).length===0 && right[0].coeff !== 0){ const divisor = right[0].coeff; left = left.map(t => makeTerm(t.coeff / divisor, t.vars)); } } } return left; }
  function parseAddSub(){ let left = parseMulDiv(); while(peek() && (peek().type==='+' || peek().type==='-')){ const op = consume().type; const right = parseMulDiv(); if(op==='+') left = addTermLists(left, right); else left = addTermLists(left, right.map(t=>makeTerm(-t.coeff, t.vars))); } return left; }
  function multiplyTermLists(A,B){ const out=[]; for(const a of A) for(const b of B) out.push(makeTerm(a.coeff*b.coeff, multiplyVars(a.vars,b.vars))); return combineLikeTerms(out); }
  function addTermLists(A,B){ return combineLikeTerms(A.concat(B)); }
  const expr = parseAddSub(); return combineLikeTerms(expr); }
function combineLikeTerms(terms){ const map = new Map(); for(const t of terms){ const vars = {}; for(const k in t.vars) if(t.vars[k] !== 0) vars[k] = t.vars[k]; const key = termKey(vars); const prev = map.get(key) || 0; map.set(key, prev + (Number(t.coeff) || 0)); }
  const out=[]; for(const [k,coeff] of map.entries()){ if(Math.abs(coeff) < 1e-12) continue; const vars={}; if(k){ k.split('*').forEach(part => { const [name,exp] = part.split('^'); vars[name]=Number(exp); }); } out.push(makeTerm(coeff, vars)); }
  out.sort((a,b)=>{ const av = Object.keys(a.vars).length, bv = Object.keys(b.vars).length; if(av !== bv) return bv - av; const ak = termKey(a.vars), bk = termKey(b.vars); return ak < bk ? -1 : (ak>bk?1:0); }); return out; }
function termsToString(terms){ if(!terms || terms.length===0) return '0'; const parts=[]; for(const t of terms){ const coeff = t.coeff; const vars = t.vars || {}; const varNames = Object.keys(vars).sort(); let varStr = varNames.map(v => vars[v]===1 ? v : `${v}^${vars[v]}`).join('*'); const absCoeff = Math.abs(coeff);
    if(varStr){ let coeffStr = ''; if(Math.abs(absCoeff - 1) < 1e-12) coeffStr = (coeff < 0) ? '-' : ''; else coeffStr = (coeff<0?'-':'') + (absCoeff % 1 === 0 ? String(absCoeff) : String(Number(absCoeff.toFixed(8)))); parts.push(coeffStr + varStr); }
    else { const num = (coeff % 1 === 0) ? String(coeff) : String(Number(coeff.toFixed(8))); parts.push(num); } } let out=''; for(const p of parts){ if(out==='') out = p; else { if(p[0]==='-') out += ' - ' + p.slice(1); else out += ' + ' + p; } } out = out.replace(/\*/g,''); return out; }
function simplifyAlgebra(expr){ try{ const tokens = tokenize(expr); if(tokens.length===0) return null; const terms = parseExpression(tokens); if(!terms || terms.length===0) return '0'; return termsToString(terms); } catch(e){ return null; } }
function evaluateNumeric(expr){ if(!expr || expr.length > 2500) return null; const allowed = expr.replace(/[^0-9+\-*/().,^\s%]/g,' '); const sanitized = allowed.replace(/\^/g,'**').replace(/%/g,'*0.01');
  try{ const fn = Function(`"use strict"; return (${sanitized});`); const val = fn(); if(typeof val === 'number' && Number.isFinite(val)) return +Number(val.toFixed(12)); return null; }catch(e){ return null; } }
function geometryQuery(q){ if(!q) return null; const s = q.toLowerCase(); let m;
  m = s.match(/area of (?:a |the )?circle(?: with)?(?: radius| r)?[^\d\-]*([-+]?\d*\.?\d+)/i);
  if(m){ const r=Number(m[1]); if(isFinite(r)) return {answer: +(Math.PI*r*r).toFixed(8), explain:`area of circle radius ${r}`} }
  m = s.match(/circumference of (?:a |the )?circle(?: with)?(?: radius| r)?[^\d\-]*([-+]?\d*\.?\d+)/i);
  if(m){ const r=Number(m[1]); if(isFinite(r)) return {answer: +(2*Math.PI*r).toFixed(8), explain:`circumference radius ${r}`} }
  m = s.match(/area of (?:a |the )?rectangle(?: with)?(?: width)?[^\d\-]*([-+]?\d*\.?\d+)[^\d\-]+(?:height|h)[^\d\-]*([-+]?\d*\.?\d+)/i);
  if(m){ const w=Number(m[1]), h=Number(m[2]); if(isFinite(w)&&isFinite(h)) return {answer: +(w*h).toFixed(8), explain:`rectangle area ${w}×${h}`} }
  m = s.match(/area of (?:a |the )?triangle(?: with)?(?: base)?[^\d\-]*([-+]?\d*\.?\d+)[^\d\-]+(?:height|h)[^\d\-]*([-+]?\d*\.?\d+)/i);
  if(m){ const b=Number(m[1]), h=Number(m[2]); if(isFinite(b)&&isFinite(h)) return {answer: +((b*h)/2).toFixed(8), explain:`triangle area base ${b} height ${h}`} }
  m = s.match(/pythagor(?:ean|e).*a[^\d\-]*([-+]?\d*\.?\d+).*b[^\d\-]*([-+]?\d*\.?\d+)/i);
  if(m){ const a=Number(m[1]), b=Number(m[2]); if(isFinite(a)&&isFinite(b)) return {answer: +(Math.sqrt(a*a + b*b)).toFixed(8), explain:`hypotenuse from ${a},${b}`} }
  m = s.match(/volume of (?:a |the )?sphere(?: with)?(?: radius)?[^\d\-]*([-+]?\d*\.?\d+)/i);
  if(m){ const r=Number(m[1]); if(isFinite(r)) return {answer: +((4/3)*Math.PI*r*r*r).toFixed(8), explain:`sphere volume radius ${r}`} }
  m = s.match(/volume of (?:a |the )?cylind(?:er|rical).*radius[^\d\-]*([-+]?\d*\.?\d+)[^\d\-]+height[^\d\-]*([-+]?\d*\.?\d+)/i);
  if(m){ const r=Number(m[1]), h=Number(m[2]); if(isFinite(r)&&isFinite(h)) return {answer: +(Math.PI * r*r * h).toFixed(8), explain:`cylinder r=${r} h=${h}`} }
  return null;
}

/* ---------- Key handling ---------- */
const STORAGE_KEY = 'gomega_openai_key_temp';
function setOpenAIKeyTemp(key){ if(!key) { sessionStorage.removeItem(STORAGE_KEY); return; } sessionStorage.setItem(STORAGE_KEY, normalizeKey(key)); }
function getOpenAIKey(){ if(OWNER_API_KEY) return OWNER_API_KEY; const temp = sessionStorage.getItem(STORAGE_KEY) || ''; return normalizeKey(temp); }
setKeyBtn.addEventListener('click', async ()=>{
  if(OWNER_API_KEY){ alert('Owner API key is set in the file; you cannot change it from the UI.'); return; }
  const prev = sessionStorage.getItem(STORAGE_KEY) || '';
  const k = prompt('Paste a temporary OpenAI API key (stored in sessionStorage).\\nCommas in the key will be removed automatically.', prev);
  if(k) { setOpenAIKeyTemp(k.trim()); alert('Temporary key set for this session.'); }
});
window.addEventListener('load', ()=>{ if(OWNER_API_KEY){ try{ setKeyBtn.style.display = 'none'; }catch(e){} } else { try{ setKeyBtn.style.display = ''; }catch(e){} } });

/* ---------- Plus codes ---------- */
const PLUS_CODE_STORE = 'gomega_plus_code';
async function tryLoadPremiumCodes(){
  try {
    const res = await fetch('https://gomega.watch/browser/premiumcodes.txt', {cache:'no-cache'});
    if(!res.ok) return;
    const txt = await res.text();
    premiumCodes = txt.split(',').map(s=>s.trim()).filter(Boolean);
    const stored = (localStorage.getItem(PLUS_CODE_STORE) || '').trim();
    if(stored && premiumCodes.includes(stored)){ premiumUnlocked = true; }
    else if(stored){ premiumUnlocked = false; localStorage.removeItem(PLUS_CODE_STORE); alert('Your saved Plus code is no longer valid. Please update your code.'); }
    renderModels(); updateQuotaUI();
  } catch(e){}
}
applyCodeBtn.addEventListener('click', ()=>{
  const raw = premiumCodeInput.value.trim();
  if(!raw) return alert('Enter at least one code (separate with commas).');
  const entered = raw.split(',').map(s=>s.trim()).filter(Boolean);
  let ok = false, matched='';
  for(const code of entered){ if(premiumCodes.includes(code)){ ok = true; matched = code; break; } }
  if(ok){ premiumUnlocked = true; localStorage.setItem(PLUS_CODE_STORE, matched); alert('Plus unlocked!'); renderModels(); updateQuotaUI(); }
  else { premiumUnlocked = false; alert('No matching Plus code found.'); }
});
tryLoadPremiumCodes();

/* ---------- Models UI ---------- */
function renderModels(){
  modelSelect.innerHTML = '';
  modelListEl.innerHTML = '';
  for(const key of Object.keys(MODEL_CONFIG)){
    const cfg = MODEL_CONFIG[key];
    const opt = document.createElement('option');
    opt.value = key;
    opt.textContent = cfg.label + (cfg.premium ? ' • plus' : '');
    if(cfg.premium && !premiumUnlocked && key !== 'gomega-v6') opt.disabled = true;
    modelSelect.appendChild(opt);
    const row = document.createElement('div');
    row.className = 'modelRow';
    row.innerHTML = `<div><strong>${cfg.label}</strong>${cfg.premium ? '<span class="badgePlus">Plus</span>' : ''}</div>`;
    const btn = document.createElement('button');
    btn.className='small';
    btn.textContent = (key===currentModelKey ? 'Selected' : 'Select');
    btn.onclick = () => {
      if(cfg.premium && !premiumUnlocked && key !== 'gomega-v6'){ alert('This model is Plus. Enter a Plus code to unlock it.'); return; }
      currentModelKey = key;
      Array.from(modelListEl.querySelectorAll('button')).forEach(b=>b.textContent='Select');
      btn.textContent='Selected';
      modelSelect.value = key;
      thinkingBadge.textContent = `Model: ${cfg.label}`;
    };
    row.appendChild(btn);
    modelListEl.appendChild(row);
  }
  modelSelect.value = currentModelKey;
}

/* ---------- Photos (kept) ---------- */
const DAILY_QUOTA = 5;
function quotaKeyForToday(){ const d = new Date(); const y = d.getFullYear(), m = String(d.getMonth()+1).padStart(2,'0'), day = String(d.getDate()).padStart(2,'0'); return `gomega_photo_quota_${y}${m}${day}`; }
function getQuotaUsed(){ if(premiumUnlocked) return 0; return parseInt(localStorage.getItem(quotaKeyForToday()) || '0', 10); }
function incrementQuota(){ if(premiumUnlocked) return 0; const k = quotaKeyForToday(); const u = getQuotaUsed()+1; localStorage.setItem(k, String(u)); updateQuotaUI(); return u; }
function updateQuotaUI(){ const left = premiumUnlocked ? '∞' : Math.max(0, DAILY_QUOTA - getQuotaUsed()); photoQuotaEl.textContent = left; }
addPhotoBtn.addEventListener('click', ()=>{ const f = photoInput.files && photoInput.files[0]; if(!f) return alert('Choose an image file first.'); if(!/^image\//.test(f.type)) return alert('Only images allowed');
  const r = new FileReader(); r.onload = (ev) => { const id = 'p' + Date.now(); photos.push({id, name: f.name, file: f, url: ev.target.result, sent:false}); renderPhotos(); }; r.readAsDataURL(f); });
function renderPhotos(){
  photoGrid.innerHTML = '';
  photos.forEach(p=>{
    const card = document.createElement('div'); card.className='photoCard';
    const img = document.createElement('img'); img.src = p.url; img.alt = p.name; card.appendChild(img);
    const actions = document.createElement('div'); actions.className='photoActions';
    const sendBtn = document.createElement('button'); sendBtn.className='small'; sendBtn.textContent = p.sent ? 'Sent' : 'Send';
    sendBtn.onclick = async () => {
      if(p.sent){ alert('Already sent'); return; }
      if(!premiumUnlocked && getQuotaUsed() >= DAILY_QUOTA){ alert('Daily photo send limit reached (5). Try again tomorrow or unlock Plus.'); return; }
      addBubble('ai', `<span class="small">Uploading image "${escapeHtml(p.name)}" to OpenAI (if allowed)...</span>`);
      setThinkingText('Uploading image...'); setProgress(12);
      try{
        const uploadResult = await tryUploadImageToOpenAI(p.file);
        if(uploadResult.ok && uploadResult.fileId){
          addBubble('user', `<div style="font-size:13px;color:var(--muted);margin-bottom:6px">Image uploaded to OpenAI: <strong>${escapeHtml(p.name)}</strong></div><div class="small">File ID: ${escapeHtml(uploadResult.fileId)}</div>`);
          session.push({role:'user', text:`[image:uploaded:${p.name}]`, img:p, fileId:uploadResult.fileId}); pushMsgToChat('user', `[image:uploaded:${p.name}]`);
          p.sent = true; incrementQuota(); renderPhotos(); updateSessionUI(); setProgress(100); setThinkingText('Idle'); lastFetchEl.textContent = new Date().toLocaleString();
        } else {
          addBubble('user', `<div style="font-size:13px;color:var(--muted);margin-bottom:6px">Image embedded (fallback): <strong>${escapeHtml(p.name)}</strong></div><img src="${p.url}" style="max-width:320px;width:100%;border-radius:8px">`);
          session.push({role:'user', text:`[image:embedded:${p.name}]`, img:p}); pushMsgToChat('user', `[image:embedded:${p.name}]`);
          p.sent = true; incrementQuota(); renderPhotos(); updateSessionUI();
          setProgress(100); setThinkingText('Idle');
        }
      } catch(e){
        console.error(e);
        addBubble('ai', `<div class="small">Image upload failed: ${escapeHtml(String(e.message || e))}. Sent as embedded image instead.</div>`);
        addBubble('user', `<div style="font-size:13px;color:var(--muted);margin-bottom:6px">Image embedded (error): <strong>${escapeHtml(p.name)}</strong></div><img src="${p.url}" style="max-width:320px;width:100%;border-radius:8px">`);
        session.push({role:'user', text:`[image:embedded:${p.name}]`, img:p}); pushMsgToChat('user', `[image:embedded:${p.name}]`);
        p.sent = true; incrementQuota(); renderPhotos(); updateSessionUI(); setProgress(100); setThinkingText('Idle');
      }
    };
    const removeBtn = document.createElement('button'); removeBtn.className='small'; removeBtn.textContent='Remove';
    removeBtn.onclick = ()=>{ photos = photos.filter(x=>x.id !== p.id); renderPhotos(); };
    actions.appendChild(sendBtn); actions.appendChild(removeBtn); card.appendChild(actions); photoGrid.appendChild(card);
  });
  updateQuotaUI();
}
async function tryUploadImageToOpenAI(file){
  const apiKey = getOpenAIKey(); if(!apiKey) return {ok:false, reason:'no-api-key'};
  try{
    const form = new FormData(); form.append('file', file, file.name); form.append('purpose', 'answers');
    const res = await fetch('https://api.openai.com/v1/files', { method: 'POST', headers: { 'Authorization': `Bearer ${apiKey}` }, body: form });
    if(!res.ok){ const text = await res.text(); return {ok:false, reason:`upload-failed-status-${res.status}`, details: text}; }
    const data = await res.json();
    if(data && data.id) return {ok:true, fileId: data.id, details: data};
    return {ok:false, reason:'no-id-in-response', details:data};
  } catch(err){ return {ok:false, reason: String(err.message || 'network/cors')}; }
}

/* ---------- Snippet gathering (kept) ---------- */
async function fetchWikiSummary(q){ try{ const r = await fetch(`https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(q)}`); if(!r.ok) return null; const j = await r.json(); return j.extract || null; }catch(e){ return null; } }
async function fetchDDG(q){ try{ const r = await fetch(`https://api.duckduckgo.com/?q=${encodeURIComponent(q)}&format=json&no_html=1&skip_disambig=1`); if(!r.ok) return null; const j = await r.json(); return j.Abstract || (j.RelatedTopics ? j.RelatedTopics.map(t=>t.Text).join('. ') : null);}catch(e){return null;} }
async function fetchWikiSearchSummaries(q, limit=6){ const out=[]; try{ const r = await fetch(`https://en.wikipedia.org/w/api.php?action=query&format=json&list=search&srsearch=${encodeURIComponent(q)}&srlimit=${limit}&origin=*`);
  if(!r.ok) return out; const j = await r.json(); const hits = j.query?.search || []; for(const h of hits){ try{ const s = await fetchWikiSummary(h.title); if(s) out.push(s); }catch(e){} if(out.length>=limit) break; } }catch(e){} return out; }
const EXPANSIONS = ['history','release date','overview','timeline','founding','specifications','launch date','origin','background'];
async function gatherSnippets(query, desired=10, aggressive=false, progressCb){
  const snippets=[]; progressCb && progressCb('Trying Wikipedia summary...'); const s1 = await fetchWikiSummary(query); if(s1) snippets.push(s1);
  progressCb && progressCb('Trying DuckDuckGo...'); const d = await fetchDDG(query); if(d) snippets.push(d);
  progressCb && progressCb('Searching wiki hits...'); const hits = await fetchWikiSearchSummaries(query, Math.max(3, Math.min(8, desired))); hits.forEach(h=>snippets.push(h));
  if(aggressive){ for(const ex of EXPANSIONS){ if(snippets.length>=desired) break; progressCb && progressCb(`Expanding: ${ex}`); const t = await fetchWikiSummary(query + ' ' + ex); if(t) snippets.push(t); } }
  const seen = new Set(); const out=[]; for(const t of snippets){ const key = t.slice(0,200).replace(/\s+/g,' ').trim(); if(!seen.has(key)){ seen.add(key); out.push(t); } if(out.length>=desired) break; } return out;
}
function extractYear(text){ if(!text) return null; const m = text.match(/\b(17\d{2}|18\d{2}|19\d{2}|20\d{2}|2100)\b/g); if(!m) return null; const freq={}; for(const y of m) freq[y]=(freq[y]||0)+1; return Object.keys(freq).sort((a,b)=>freq[b]-freq[a])[0]; }
function pickBest(snips, query, modelKey, strictOnly){
  if(!snips || snips.length===0) return {answer:"I couldn't find an answer.", confidence:8};
  const wantsYear = /\bwhat\s+year|\bwhen\s+was|\bwhen\s+did\b/i.test(query) || /only the year|just the year/i.test(query);
  if(wantsYear){ const years=[]; for(const s of snips){ const y = extractYear(s); if(y) years.push(y); } if(years.length>0){ const freq={}; for(const y of years) freq[y]=(freq[y]||0)+1; const pick = Object.keys(freq).sort((a,b)=>freq[b]-freq[a])[0];
    const conf = Math.min(95, 40 + (freq[pick]-1)*20 + Math.min(40, snips.length*3)); return {answer: pick, confidence:conf}; }
  }
  let best = snips.slice().sort((a,b)=>b.length - a.length)[0];
  const sentences = (best||'').split(/(?<=\.)\s+/).filter(Boolean);
  const verb = MODEL_CONFIG[modelKey].verb || 1; const take = Math.max(1, Math.floor(verb * 1.6));
  let answer = sentences.slice(0,take).join(' ').trim(); if(!answer) answer = (best||'').slice(0,300).trim();
  if(strictOnly && /\bonly the year\b|\bonly the number\b/i.test(query)){ const n = answer.match(/-?\d+(\.\d+)?/); if(n) return {answer:n[0], confidence: Math.min(90, 20 + snips.length*6)}; }
  const filled = snips.filter(s=>s.length>40).length; let conf = Math.min(95, 30 + filled*8 + Math.min(30, (snips.length-1)*3));
  const yearsFound = {}; snips.forEach(s=>{ const y = extractYear(s); if(y) yearsFound[y] = (yearsFound[y]||0)+1; });
  if(Object.keys(yearsFound).length>0){ const bestY = Object.keys(yearsFound).sort((a,b)=>yearsFound[b]-yearsFound[a])[0]; conf += Math.min(10, (yearsFound[bestY]-1)*5); }
  conf = Math.min(99, Math.max(8, Math.round(conf)));
  return {answer, confidence:conf};
}

/* ---------- V6 free uses ---------- */
const V6_USES_KEY = 'gomega_v6_free_uses';
function getV6Uses(){ return parseInt(localStorage.getItem(V6_USES_KEY) || '0', 10); }
function incrementV6Uses(){ const u = getV6Uses() + 1; localStorage.setItem(V6_USES_KEY, String(u)); return u; }

/* ---------- Think Harder (3/day) ---------- */
const THINK_HARDER_KEY = 'gomega_think_harder_used';
function todayKey(){ const d=new Date(); return `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`; }
function getThinkHarderCount(){ const raw = localStorage.getItem(THINK_HARDER_KEY); if(!raw) return 0; try{ const obj=JSON.parse(raw); return obj.day===todayKey() ? obj.count : 0; }catch(e){ return 0; } }
function incThinkHarder(){ const c = getThinkHarderCount()+1; localStorage.setItem(THINK_HARDER_KEY, JSON.stringify({day:todayKey(), count:c})); return c; }
thinkHarderBtn.addEventListener('click', ()=>{
  const used = getThinkHarderCount();
  if(used>=3){ alert('Think harder limit reached for today (3).'); return; }
  thinkHarderActive = true; incThinkHarder();
  addBubble('ai', '<span class="small">Think harder primed for the next question.</span>'); pushMsgToChat('ai','[system] Think harder primed');
});

/* ---------- Multi‑chat: storage, UI, actions ---------- */
const CHAT_STORE_KEY = 'gomega_chats_v1';
const ACTIVE_CHAT_ID_KEY = 'gomega_active_chat';
let chats = [];
let activeChatId = null;

function uuid(){ return 'c' + Math.random().toString(36).slice(2) + Date.now().toString(36); }

function loadChats(){
  try{ chats = JSON.parse(localStorage.getItem(CHAT_STORE_KEY) || '[]'); }catch(e){ chats=[]; }
  activeChatId = localStorage.getItem(ACTIVE_CHAT_ID_KEY) || (chats[0]?.id || null);
  if(!activeChatId){ const id = createNewChat('New Chat'); activeChatId = id; }
  renderChatList();
}
function saveChats(){ localStorage.setItem(CHAT_STORE_KEY, JSON.stringify(chats)); }
function setActiveChat(id){ activeChatId = id; localStorage.setItem(ACTIVE_CHAT_ID_KEY, id); renderChatList(); renderChatMessages(); }
function getActiveChat(){ return chats.find(c=>c.id===activeChatId); }
function createNewChat(title){
  const id = uuid();
  const chat = { id, title: title || 'New Chat', createdAt: Date.now(), updatedAt: Date.now(), messages: [] };
  chats.unshift(chat); saveChats(); setActiveChat(id); return id;
}
function deleteChat(id){
  const idx = chats.findIndex(c=>c.id===id);
  if(idx<0) return;
  chats.splice(idx,1); saveChats();
  if(activeChatId===id){ if(chats.length){ setActiveChat(chats[0].id); } else { const newId = createNewChat('New Chat'); setActiveChat(newId); } }
  renderChatList();
}
function renameChat(id, newTitle){
  const c = chats.find(c=>c.id===id); if(!c) return;
  c.title = (newTitle || c.title).slice(0,60);
  c.updatedAt = Date.now(); saveChats(); renderChatList();
}
function pushMsgToChat(role, text){
  const c = getActiveChat(); if(!c) return;
  c.messages.push({role, text, ts: Date.now()});
  c.updatedAt = Date.now(); saveChats();
  // auto‑title from first user message
  if(c.messages.length===1 && role==='user'){
    const t = text.replace(/\s+/g,' ').trim().slice(0,40);
    if(t) { c.title = t; saveChats(); renderChatList(); }
  }
}
function renderChatList(){
  chatsListEl.innerHTML = '';
  chats.forEach(c=>{
    const row = document.createElement('div');
    row.className = 'chatItem' + (c.id===activeChatId ? ' active' : '');
    row.innerHTML = `<div class="title">${escapeHtml(c.title || 'Untitled')}</div>`;
    const actions = document.createElement('div'); actions.className = 'actions';
    const sel = document.createElement('button'); sel.className='small'; sel.textContent='Open'; sel.onclick = ()=>setActiveChat(c.id);
    const ren = document.createElement('button'); ren.className='small'; ren.textContent='✎'; ren.title='Rename'; ren.onclick = ()=>{ const t = prompt('New title', c.title||''); if(t) renameChat(c.id, t); };
    const del = document.createElement('button'); del.className='small'; del.textContent='🗑'; del.title='Delete'; del.onclick = ()=>{ if(confirm('Delete this chat?')) deleteChat(c.id); };
    actions.appendChild(sel); actions.appendChild(ren); actions.appendChild(del);
    row.appendChild(actions);
    chatsListEl.appendChild(row);
  });
}
function renderChatMessages(){
  const c = getActiveChat(); messagesEl.innerHTML=''; session=[];
  if(!c){ return; }
  c.messages.forEach(m=>{
    addBubble(m.role, escapeHtml(m.text));
    session.push({role:m.role, text:m.text});
  });
  updateSessionUI();
}

newChatBtn.addEventListener('click', ()=>createNewChat('New Chat'));
renameChatBtn.addEventListener('click', ()=>{ const c=getActiveChat(); if(!c) return; const t=prompt('New title', c.title||''); if(t) renameChat(c.id,t); });
deleteChatBtn.addEventListener('click', ()=>{ const c=getActiveChat(); if(!c) return; if(confirm('Delete this chat?')) deleteChat(c.id); });
exportChatBtn.addEventListener('click', ()=>{
  const c=getActiveChat(); if(!c) return;
  const blob = new Blob([JSON.stringify(c,null,2)], {type:'application/json'});
  const a = Object.assign(document.createElement('a'), {href: URL.createObjectURL(blob), download: (c.title||'chat')+'.json'});
  document.body.appendChild(a); a.click(); setTimeout(()=>URL.revokeObjectURL(a.href), 1000); a.remove();
});
exportAllBtn.addEventListener('click', ()=>{
  const blob = new Blob([JSON.stringify(chats,null,2)], {type:'application/json'});
  const a = Object.assign(document.createElement('a'), {href: URL.createObjectURL(blob), download: 'gomega-chats.json'});
  document.body.appendChild(a); a.click(); setTimeout(()=>URL.revokeObjectURL(a.href), 1000); a.remove();
});
importChatsInput.addEventListener('change', async (ev)=>{
  const f = ev.target.files && ev.target.files[0]; if(!f) return;
  try{
    const text = await f.text();
    const data = JSON.parse(text);
    if(Array.isArray(data)){ chats = data.concat(chats); }
    else if(data && data.id){ chats.unshift(data); }
    else { alert('Not a recognized chat JSON.'); return; }
    saveChats(); renderChatList(); if(chats.length && !activeChatId){ setActiveChat(chats[0].id); }
  }catch(e){ alert('Failed to import chats: '+(e.message||e)); }
});

/* ---------- Long‑term memory (persistent) ---------- */
const MEMORY_KEY = 'gomega_memory_v1';
let memory = [];
function loadMemory(){ try{ memory = JSON.parse(localStorage.getItem(MEMORY_KEY) || '[]'); }catch(e){ memory=[]; } renderMemoryUI(); }
function saveMemory(){ localStorage.setItem(MEMORY_KEY, JSON.stringify(memory)); }
function addMemory(text){ if(!text.trim()) return; memory.push({id: uuid(), text: text.trim(), ts: Date.now()}); saveMemory(); renderMemoryUI(); memoryInput.value=''; }
function deleteMemory(id){ memory = memory.filter(m=>m.id!==id); saveMemory(); renderMemoryUI(); }
function renderMemoryUI(){
  memoryListEl.innerHTML = '';
  if(memory.length===0){ memoryListEl.innerHTML = '<div class="small">No saved memory yet.</div>'; return; }
  memory.slice().reverse().forEach(m=>{
    const row = document.createElement('div'); row.className='memoryRow';
    row.innerHTML = `<div class="small" style="flex:1;overflow:hidden;text-overflow:ellipsis">${escapeHtml(m.text)}</div>`;
    const b = document.createElement('button'); b.className='small'; b.textContent='Forget'; b.onclick = ()=>deleteMemory(m.id);
    row.appendChild(b); memoryListEl.appendChild(row);
  });
}
addMemoryBtn.addEventListener('click', ()=>addMemory(memoryInput.value));
memoryInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ addMemory(memoryInput.value); } });

/* ---------- Model rendering (call now) ---------- */
renderModels();

/* ---------- Looks‑like‑math tweak ---------- */
function looksLikeMath(q){
  const hasOperators = /[+\-*/^%]/.test(q);
  const hasKeywords = /\b(simplify|evaluate|area|circumference|perimeter|volume|pythagor|triangle|circle|radius|diameter|height|base)\b/i.test(q);
  const algebraish = /[a-zA-Z]\s*([+\-*/^])\s*[a-zA-Z0-9(]/.test(q) || /\d+\s*[a-zA-Z]/.test(q) || /\)\s*[+\-*/^]\s*\(/.test(q);
  return hasOperators || hasKeywords || algebraish;
}

/* ---------- OpenAI call (augmented with memory) ---------- */
async function callOpenAI(promptText, modelKey, options = {}){
  const apiKey = getOpenAIKey(); if(!apiKey) throw new Error('No OpenAI key set. Owner key is absent and no temporary key provided.');
  const cfg = MODEL_CONFIG[modelKey] || MODEL_CONFIG['gomega-v7'];
  const systemMsg = { role: 'system', content: `You are Gomega AI — a helpful assistant. Answer clearly and concisely. If asked "Who made you?" reply exactly: "ScriptNova made me — follow scriptnovaa (two a's) on Instagram."`};
  const memTxt = (memory && memory.length) ? ('Long‑term memory: ' + memory.map(m=>m.text).slice(0,24).join(' | ')) : '';
  const messages = [ systemMsg ];
  if(memTxt) messages.push({ role: 'system', content: memTxt });
  messages.push({ role: 'user', content: promptText });
  const maxTokens = premiumUnlocked ? (options.max_tokens ?? 2000) : (options.max_tokens ?? 800);
  const body = { model: cfg.openai, messages, temperature: options.temperature ?? 0.2, max_tokens: maxTokens };
  const res = await fetch('https://api.openai.com/v1/chat/completions', {
    method: 'POST',
    headers: { 'Content-Type':'application/json', 'Authorization': `Bearer ${apiKey}` },
    body: JSON.stringify(body)
  });
  if(!res.ok){
    const text = await res.text();
    let errMsg = `OpenAI request failed (${res.status})`;
    try { const json = JSON.parse(text); if(json.error && json.error.message) errMsg += `: ${json.error.message}`; }
    catch(e){ errMsg += ': ' + text; }
    throw new Error(errMsg);
  }
  const data = await res.json();
  const reply = data.choices && data.choices[0] && (data.choices[0].message?.content || data.choices[0].text) ? (data.choices[0].message?.content || data.choices[0].text) : 'No response';
  return reply;
}

/* ---------- Main ask flow ---------- */
askBtn.addEventListener('click', onAsk);
promptEl.addEventListener('keydown', (e) => { if(e.key==='Enter' && !e.shiftKey){ onAsk(); e.preventDefault(); } });
document.getElementById('clearBtn').addEventListener('click', ()=>{ messagesEl.innerHTML=''; session=[]; updateSessionUI(); });

async function onAsk(){
  if(typingLocked) return;
  const qRaw = (promptEl.value || '').trim(); if(!qRaw) return; promptEl.value = '';
  addBubble('user', escapeHtml(qRaw));
  session.push({role:'user', text:qRaw}); pushMsgToChat('user', qRaw);
  updateSessionUI();
  setTypingLocked(true);
  const aiNode = addBubble('ai', '<span class="small">Gomega is thinking…</span>'); const typingDots = addTypingIndicator(aiNode);
  setThinkingText('Deciding strategy...'); setProgress(6);
  try{
    const selectedModelKey = modelSelect.value || currentModelKey;
    // creator intercept
    if(/\bwho (?:made|created) (?:you|this)\b/i.test(qRaw) || /^who(?:'s| is)? the creator\b/i.test(qRaw)){
      removeTypingIndicator(typingDots);
      const reply = 'ScriptNova made me — follow scriptnovaa (two a\'s) on Instagram.';
      await typeTextInto(aiNode, reply, MODEL_CONFIG[currentModelKey].speed * 0.9);
      session.push({role:'ai', text:reply}); pushMsgToChat('ai', reply); updateSessionUI(); setTypingLocked(false); setThinkingText('Idle'); setProgress(0); return;
    }
    if(/\bwhat (?:model|version) (?:am i|are we) using\b/i.test(qRaw) || /\bwhich model\b/i.test(qRaw)){
      removeTypingIndicator(typingDots);
      const cfg = MODEL_CONFIG[currentModelKey]; const reply = `You're using: ${cfg.label}`;
      await typeTextInto(aiNode, reply, MODEL_CONFIG[currentModelKey].speed * 0.9);
      session.push({role:'ai', text:reply}); pushMsgToChat('ai', reply); updateSessionUI(); setTypingLocked(false); setThinkingText('Idle'); setProgress(0); return;
    }
    // V6 limit
    if(selectedModelKey === 'gomega-v6' && !premiumUnlocked){
      const uses = getV6Uses();
      if(uses >= 3){
        removeTypingIndicator(typingDots);
        const msg = `Gomega V6 is available for free testing but you've used it ${uses} times. Enter a Plus code to continue using V6 without limits.`;
        await typeTextInto(aiNode, msg, MODEL_CONFIG['gomega-v6'].speed * 1.2);
        session.push({role:'ai', text: msg}); pushMsgToChat('ai', msg); updateSessionUI(); setTypingLocked(false); setThinkingText('Idle'); setProgress(0); return;
      } else { incrementV6Uses(); }
    }
    // algebra simplification
    const needSimplify = /\bsimplify\b/i.test(qRaw) || (/[a-zA-Z]/.test(qRaw) && /[+\-*/^()]/.test(qRaw));
    if(needSimplify && looksLikeMath(qRaw)){
      setThinkingText('Simplifying algebra locally...'); setProgress(26);
      const simplified = simplifyAlgebra(qRaw) || simplifyAlgebra(qRaw.replace(/simplify/i,'').trim());
      if(simplified){
        removeTypingIndicator(typingDots);
        if(premiumUnlocked){
          const numericCheck = evaluateNumeric(qRaw);
          const extra = (numericCheck !== null) ? `\n\nSmartMath check (plus): computed numeric value = ${numericCheck}` : `\n\nSmartMath (plus): returned algebraic simplification.`;
          await typeTextInto(aiNode, simplified + extra, Math.max(4, MODEL_CONFIG[currentModelKey].speed * 0.6));
          session.push({role:'ai', text:simplified + (numericCheck!==null?` (=${numericCheck})`:'')});
        } else {
          await typeTextInto(aiNode, simplified, MODEL_CONFIG[currentModelKey].speed * 1.4);
          session.push({role:'ai', text:simplified});
        }
        pushMsgToChat('ai', simplified);
        updateSessionUI(); confidenceEl.textContent = '99%'; lastFetchEl.textContent = new Date().toLocaleString(); setProgress(100); setThinkingText('Idle'); setTimeout(()=>{ setProgress(0); setTypingLocked(false); },700); return;
      }
    }
    // geometry
    const geom = looksLikeMath(qRaw) ? geometryQuery(qRaw) : null;
    if(geom){
      setThinkingText('Computing geometry locally...'); setProgress(30);
      removeTypingIndicator(typingDots);
      const answer = String(geom.answer);
      if(premiumUnlocked){ await typeTextInto(aiNode, answer + `\n\nReason (plus): ${geom.explain}`, Math.max(4, MODEL_CONFIG[currentModelKey].speed * 0.6)); }
      else { await typeTextInto(aiNode, answer, MODEL_CONFIG[currentModelKey].speed * 1.4); const meta = document.createElement('div'); meta.className='explain'; meta.textContent = `Reason: ${geom.explain}`; aiNode.appendChild(meta); }
      session.push({role:'ai', text:answer}); pushMsgToChat('ai', answer); updateSessionUI(); confidenceEl.textContent = '99%'; lastFetchEl.textContent = new Date().toLocaleString(); setProgress(100); setThinkingText('Idle'); setTimeout(()=>{ setProgress(0); setTypingLocked(false); },700); return;
    }
    // OpenAI path
    const key = getOpenAIKey();
    if(key){
      setThinkingText('Calling OpenAI...'); setProgress(18);
      const cfg = MODEL_CONFIG[selectedModelKey];
      if(cfg.premium && !premiumUnlocked && selectedModelKey !== 'gomega-v6'){ throw new Error('This model is Plus. Enter a Plus code or host premiumcodes.txt.'); }
      try {
        const openAiOptions = { temperature: thinkHarderActive ? 0.35 : 0.15, max_tokens: premiumUnlocked ? (thinkHarderActive ? 2800 : 2000) : (thinkHarderActive ? 900 : 700) };
        const reply = await callOpenAI(qRaw, selectedModelKey, openAiOptions);
        removeTypingIndicator(typingDots); setProgress(70);
        const speed = premiumUnlocked ? Math.max(4, MODEL_CONFIG[selectedModelKey].speed * 0.5) : Math.max(6, MODEL_CONFIG[selectedModelKey].speed * 1.4);
        await typeTextInto(aiNode, reply, speed);
        session.push({role:'ai', text: reply}); pushMsgToChat('ai', reply); updateSessionUI(); confidenceEl.textContent = '—'; lastFetchEl.textContent = new Date().toLocaleString(); setProgress(100); setThinkingText('Idle');
        thinkHarderActive = false;
        setTimeout(()=>{ setProgress(0); setTypingLocked(false); },800); return;
      } catch(openErr){ console.warn('OpenAI failed:', openErr); }
    }
    // fallback gather
    setThinkingText('Searching multiple sources (client-side)...'); setProgress(14);
    const aggressive = (thinkingToggle.checked || selectedModelKey.startsWith('gomega-v6') || selectedModelKey.startsWith('gomega-v8') || premiumUnlocked || thinkHarderActive);
    const desired = thinkHarderActive ? 16 : 10;
    const snippets = await gatherSnippets(qRaw, desired, aggressive, (msg)=>{ lastAction.textContent = msg; const cur = parseInt(progressBar.style.width) || 10; setProgress(Math.min(90, cur + 8)); });
    if(!snippets || snippets.length===0){
      removeTypingIndicator(typingDots);
      await typeTextInto(aiNode, "I couldn't find an answer — I tried looking it up.", MODEL_CONFIG[currentModelKey].speed * 1.8);
      session.push({role:'ai', text:"I couldn't find an answer — I tried looking it up."}); pushMsgToChat('ai', "I couldn't find an answer — I tried looking it up."); updateSessionUI(); confidenceEl.textContent = '10%'; setTypingLocked(false); setThinkingText('Idle'); setProgress(0); thinkHarderActive=false; return;
    }
    setProgress(86);
    const strict = strictToggle.checked;
    const picked = pickBest(snippets, qRaw, selectedModelKey, strict);
    const verification = looksLikeMath(qRaw) ? evaluateNumeric(qRaw) : null;
    let finalAnswer = picked.answer;
    if(verification !== null && !/\bonly the number\b/i.test(qRaw)) finalAnswer += `\n\n(Computed: ${verification})`;
    removeTypingIndicator(typingDots);
    const speed = premiumUnlocked ? Math.max(6, MODEL_CONFIG[selectedModelKey].speed * 0.6) : Math.max(10, Math.round(MODEL_CONFIG[selectedModelKey].speed * 1.6));
    await typeTextInto(aiNode, finalAnswer, speed);
    const meta = document.createElement('div'); meta.className='explain'; meta.textContent = `Confidence: ${picked.confidence}%`; aiNode.appendChild(meta);
    session.push({role:'ai', text: finalAnswer}); pushMsgToChat('ai', finalAnswer); updateSessionUI(); lastFetchEl.textContent = new Date().toLocaleString(); confidenceEl.textContent = picked.confidence + '%';
    setProgress(100); setThinkingText('Idle'); thinkHarderActive=false;
    setTimeout(()=>{ setProgress(0); setTypingLocked(false); }, 800);
  } catch(err){
    console.error(err);
    removeTypingIndicator(typingDots);
    const msg = '⚠️ Error: ' + (err.message || 'failed to compute');
    const node = messagesEl.querySelector('.bubble.ai:last-child') || addBubble('ai','');
    node.innerHTML = escapeHtml(msg);
    session.push({role:'ai', text: msg}); pushMsgToChat('ai', msg); updateSessionUI(); setTypingLocked(false); setThinkingText('Idle'); setProgress(0);
    thinkHarderActive=false;
  }
}

/* ---------- Session & page init ---------- */
document.getElementById('clearSession').addEventListener('click', ()=>{ session=[]; messagesEl.innerHTML=''; updateSessionUI(); });

(function init(){
  renderModels(); updateQuotaUI(); renderPhotos();
  loadMemory();
  loadChats(); renderChatMessages();
  addBubble('ai', 'Welcome to Gomega AI. We are trying really hard to update the AI regularly. Please go to the GPD doc and report any errors.');
  addBubble('ai', 'Follow scriptnovaa on Instagram"');
  updateSessionUI(); tickLocalTime();
})();
function tickLocalTime(){ document.getElementById('localTime').textContent = new Date().toLocaleString(); setTimeout(tickLocalTime,1000); }

/* ---------- Analytics (optional; replace G-XXXXXXX) ---------- */
window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-XXXXXXX');

</script>
</body>
</html>
